<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö—Ä–µ–¥–∏—Ç–Ω—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="header-info">
                    <h1>üí∞ –ö—Ä–µ–¥–∏—Ç–Ω—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</h1>
                    <p>–†–∞—Å—á–µ—Ç –∫—Ä–µ–¥–∏—Ç–Ω—ã—Ö –≤—ã–ø–ª–∞—Ç –æ—Ç –¥—Ä—É–≥–∞</p>
                </div>
                <div class="user-info">
                    <button onclick="toggleTheme()" class="theme-toggle-btn" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåô</button>
                    <span id="userRole" class="user-role"></span>
                    <button onclick="logout()" class="logout-btn">üö™ –í—ã–π—Ç–∏</button>
                </div>
            </div>
        </header>

        <!-- –í–∫–ª–∞–¥–∫–∏ -->
        <div class="tabs" role="tablist" aria-label="–û—Å–Ω–æ–≤–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è">
            <button class="tab-button active" onclick="showTab('calculate')" id="calculateTab" 
                    role="tab" aria-selected="true" aria-controls="calculate" aria-label="–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –Ω–æ–≤—ã–π –∫—Ä–µ–¥–∏—Ç">üí≥ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∫—Ä–µ–¥–∏—Ç</button>
            <button class="tab-button" onclick="showTab('history')" id="historyTab"
                    role="tab" aria-selected="false" aria-controls="history" aria-label="–ü—Ä–æ—Å–º–æ—Ç—Ä –∏—Å—Ç–æ—Ä–∏–∏ –∫—Ä–µ–¥–∏—Ç–æ–≤">üìã –ò—Å—Ç–æ—Ä–∏—è –∫—Ä–µ–¥–∏—Ç–æ–≤</button>
            <button class="tab-button" onclick="showTab('management')" id="managementTab" style="display: none;"
                    role="tab" aria-selected="false" aria-controls="management" aria-label="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏">üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button>
        </div>

        <div class="main-content">
            <!-- –í–∫–ª–∞–¥–∫–∞: –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∫—Ä–µ–¥–∏—Ç -->
            <div id="calculate" class="tab-content" role="tabpanel" aria-labelledby="calculateTab" aria-hidden="false">
                <!-- –§–æ—Ä–º–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫—Ä–µ–¥–∏—Ç–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∫—Ä–µ–¥–∏—Ç–æ–¥–∞—Ç–µ–ª–µ–π) -->
            <div class="form-section" id="loanFormSection">
                <h2>üìù –ù–æ–≤—ã–π –∫—Ä–µ–¥–∏—Ç</h2>
                <form id="loanForm">
                    <div class="form-group">
                        <label for="amount">–°—É–º–º–∞ –∫—Ä–µ–¥–∏—Ç–∞ (‚ÇΩ):</label>
                        <input type="text" id="amount" name="amount" placeholder="0 000" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="interest_rate">–ü—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞ (%):</label>
                        <input type="number" id="interest_rate" name="interest_rate" step="0.01" min="0" max="100" value="12" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="start_date">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</label>
                        <input type="date" id="start_date" name="start_date" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="term_months">–°—Ä–æ–∫ –∫—Ä–µ–¥–∏—Ç–∞ (–º–µ—Å—è—Ü–µ–≤):</label>
                        <input type="number" id="term_months" name="term_months" min="1" max="600" value="60" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="borrower_id">–ó–∞–∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–Ω—ã–π:</label>
                        <select id="borrower_id" name="borrower_id" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–Ω–æ–≥–æ...</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">üí≥ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button type="button" id="calculateBtn" class="btn btn-secondary">üßÆ –¢–æ–ª—å–∫–æ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
                </form>
            </div>

            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á–µ—Ç–∞ -->
            <div class="results-section" id="resultsSection" style="display: none;">
                <h2>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á–µ—Ç–∞</h2>
                <div class="results-grid">
                    <div class="result-card">
                        <h3>–ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç–µ–∂</h3>
                        <p id="monthlyPayment">0 ‚ÇΩ</p>
                    </div>
                    <div class="result-card">
                        <h3>–û–±—â–∞—è —Å—É–º–º–∞ –≤—ã–ø–ª–∞—Ç</h3>
                        <p id="totalPayment">0 ‚ÇΩ</p>
                    </div>
                    <div class="result-card">
                        <h3>–ü–µ—Ä–µ–ø–ª–∞—Ç–∞ –ø–æ –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º</h3>
                        <p id="totalInterest">0 ‚ÇΩ</p>
                    </div>
                </div>
            </div>
            </div>
            
            <!-- –í–∫–ª–∞–¥–∫–∞: –ò—Å—Ç–æ—Ä–∏—è –∫—Ä–µ–¥–∏—Ç–æ–≤ -->
            <div id="history" class="tab-content" role="tabpanel" aria-labelledby="historyTab" aria-hidden="true" style="display: none;">
                <div class="loans-section">
                    <h2>üìã –ò—Å—Ç–æ—Ä–∏—è –∫—Ä–µ–¥–∏—Ç–æ–≤</h2>
                    <div class="loans-table-container">
                        <table id="loansTable">
                    <thead>
                        <tr>
                            <th>–ö—Ä–µ–¥–∏—Ç</th>
                            <th>–ü–µ—Ä–∏–æ–¥</th>
                            <th>–ü–ª–∞—Ç–µ–∂–∏</th>
                            <th>–ü–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–Ω—ã–π –ø–ª–∞—Ç–µ–∂</th>
                            <th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                            <tbody id="loansTableBody">
                                <!-- –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- –í–∫–ª–∞–¥–∫–∞: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
            <div id="management" class="tab-content" role="tabpanel" aria-labelledby="managementTab" aria-hidden="true" style="display: none;">
                <div class="management-container">
                    <!-- –°–µ–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–Ω–æ–≥–æ -->
                    <div class="form-section" id="createBorrowerSection">
                        <h2>üë§ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –∑–∞–∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–Ω–æ–≥–æ</h2>
                        <div class="create-borrower-form">
                            <form id="createBorrowerForm">
                                <div class="form-group">
                                    <label for="newBorrowerFullName">–§–ò–û:</label>
                                    <input type="text" id="newBorrowerFullName" name="full_name" placeholder="–í–≤–µ–¥–∏—Ç–µ –§–ò–û (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á)" required>
                                </div>
                                <div class="form-group">
                                    <label for="newBorrowerUsername">–õ–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                                    <input type="text" id="newBorrowerUsername" name="username" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" required>
                                </div>
                                <div class="form-group">
                                    <label for="newBorrowerPassword">–ü–∞—Ä–æ–ª—å:</label>
                                    <input type="password" id="newBorrowerPassword" name="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" required>
                                </div>
                                <button type="submit" class="btn btn-primary">üë§ –°–æ–∑–¥–∞—Ç—å –∑–∞–∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–Ω–æ–≥–æ</button>
                            </form>
                        </div>
                    </div>
                    
                    <!-- –°–µ–∫—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–Ω—ã—Ö -->
                    <div class="form-section" id="borrowersListSection">
                        <h2>üë• –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–Ω—ã–µ</h2>
                        <div class="borrowers-list">
                            <div id="borrowersList" class="borrowers-grid">
                                <!-- –°–ø–∏—Å–æ–∫ –∑–∞–∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–Ω—ã—Ö –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –∑–¥–µ—Å—å -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ -->
    <div id="paymentModal" class="modal" role="dialog" aria-labelledby="paymentModalTitle" aria-hidden="true">
        <div class="modal-content">
            <span class="close" aria-label="–ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ">&times;</span>
            <h2 id="paymentModalTitle">üí≥ –î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç–µ–∂</h2>
            <form id="paymentForm" enctype="multipart/form-data">
                <input type="hidden" id="paymentLoanId" name="loan_id">
                    <div class="form-group">
                        <label for="paymentAmount">–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞ (‚ÇΩ):</label>
                        <input type="text" id="paymentAmount" name="amount" placeholder="0 000" required>
                    </div>
                <div class="form-group">
                    <label for="paymentDate">–î–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞:</label>
                    <input type="date" id="paymentDate" name="payment_date" required>
                </div>
                <div class="form-group">
                    <label for="paymentDocument">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç (—á–µ–∫): <span class="required">*</span></label>
                    <input type="file" id="paymentDocument" name="file" accept=".pdf,.png,.jpg,.jpeg,.gif,.doc,.docx" required>
                    <small class="file-help">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: PDF, PNG, JPG, GIF, DOC, DOCX (–º–∞–∫—Å. 16MB)</small>
                </div>
                <button type="submit" class="btn btn-primary">üí≥ –î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç–µ–∂</button>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–ª–∞—Ç–µ–∂–µ–π -->
    <div id="paymentsModal" class="modal" role="dialog" aria-labelledby="paymentsModalTitle" aria-hidden="true">
        <div class="modal-content">
            <span class="close" aria-label="–ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ">&times;</span>
            <h2 id="paymentsModalTitle">üìä –ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π</h2>
            <div id="paymentsList">
                <!-- –ü–ª–∞—Ç–µ–∂–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π -->
    <div id="chartModal" class="modal" role="dialog" aria-labelledby="chartModalTitle" aria-hidden="true">
        <div class="modal-content chart-modal">
            <span class="close" aria-label="–ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ">&times;</span>
            <h2 id="chartModalTitle">üìà –ì—Ä–∞—Ñ–∏–∫ –ø–ª–∞—Ç–µ–∂–µ–π</h2>
            <div id="chartContainer">
                <canvas id="paymentChart" width="600" height="400"></canvas>
            </div>
        </div>
    </div>

    <script>
        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        document.getElementById('start_date').valueAsDate = new Date();
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É–º–º—ã –∫—Ä–µ–¥–∏—Ç–∞
        function formatAmount(input) {
            // –£–¥–∞–ª—è–µ–º –≤—Å–µ –Ω–µ—Ü–∏—Ñ—Ä–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã
            let value = input.value.replace(/\D/g, '');
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã –∫–∞–∂–¥—ã–µ 3 —Ü–∏—Ñ—Ä—ã —Å–ø—Ä–∞–≤–∞
            if (value.length > 0) {
                value = value.replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
            }
            
            input.value = value;
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–ª—è —Å—É–º–º—ã
        document.getElementById('amount').addEventListener('input', function(e) {
            formatAmount(e.target);
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–ª—è —Å—É–º–º—ã –ø–ª–∞—Ç–µ–∂–∞
        document.getElementById('paymentAmount').addEventListener('input', function(e) {
            formatAmount(e.target);
        });
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —á–∏—Å–ª–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è —Å—É–º–º—ã
        function getAmountValue() {
            const amountInput = document.getElementById('amount');
            return parseFloat(amountInput.value.replace(/\s/g, '')) || 0;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —á–∏—Å–ª–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è —Å—É–º–º—ã –ø–ª–∞—Ç–µ–∂–∞
        function getPaymentAmountValue() {
            const amountInput = document.getElementById('paymentAmount');
            return parseFloat(amountInput.value.replace(/\s/g, '')) || 0;
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã
        document.getElementById('loanForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = {
                amount: getAmountValue(),
                interest_rate: parseFloat(formData.get('interest_rate')),
                start_date: formData.get('start_date'),
                term_months: parseInt(formData.get('term_months')),
                borrower_id: parseInt(formData.get('borrower_id'))
            };
            
            try {
                const response = await fetch('/api/loans', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    showNotification('‚úÖ –ö—Ä–µ–¥–∏—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!', 'success');
                    this.reset();
                    document.getElementById('start_date').valueAsDate = new Date();
                    await loadLoansWithAnimation();
                    hideResults();
                } else {
                    showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫—Ä–µ–¥–∏—Ç–∞', 'error');
                }
            } catch (error) {
                showNotification('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        });

        // –ö–Ω–æ–ø–∫–∞ "–¢–æ–ª—å–∫–æ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å"
        document.getElementById('calculateBtn').addEventListener('click', async function() {
            const formData = new FormData(document.getElementById('loanForm'));
            const data = Object.fromEntries(formData.entries());
            
            if (!data.amount || !data.interest_rate || !data.term_months) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞');
                return;
            }
            
            try {
                const response = await fetch('/api/calculate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showResults(result);
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ');
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        });

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        function showResults(result) {
            document.getElementById('monthlyPayment').textContent = result.monthly_payment.toLocaleString('ru-RU') + ' ‚ÇΩ';
            document.getElementById('totalPayment').textContent = result.total_payment.toLocaleString('ru-RU') + ' ‚ÇΩ';
            document.getElementById('totalInterest').textContent = result.total_interest.toLocaleString('ru-RU') + ' ‚ÇΩ';
            document.getElementById('resultsSection').style.display = 'block';
        }

        // –°–∫—Ä—ã—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        function hideResults() {
            document.getElementById('resultsSection').style.display = 'none';
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤–∫–ª–∞–¥–∫–∞–º–∏
        function showTab(tabName) {
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => {
                tab.style.display = 'none';
                tab.setAttribute('aria-hidden', 'true');
            });
            
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(button => {
                button.classList.remove('active');
                button.setAttribute('aria-selected', 'false');
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            const selectedTab = document.getElementById(tabName);
            if (selectedTab) {
                selectedTab.style.display = 'block';
                selectedTab.setAttribute('aria-hidden', 'false');
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –∫–Ω–æ–ø–∫–µ
            const activeButton = document.querySelector(`[onclick="showTab('${tabName}')"]`);
            if (activeButton) {
                activeButton.classList.add('active');
                activeButton.setAttribute('aria-selected', 'true');
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏
            if (tabName === 'calculate') {
                // –í–∫–ª–∞–¥–∫–∞ —Ä–∞—Å—Å—á–µ—Ç–∞ –∫—Ä–µ–¥–∏—Ç–∞ - –Ω–∏—á–µ–≥–æ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ–º
            } else if (tabName === 'history') {
                loadLoansWithAnimation();
            } else if (tabName === 'management') {
                loadBorrowers();
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤ (–ø—Ä–æ—Å—Ç–∞—è –≤–µ—Ä—Å–∏—è –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
        async function loadLoans() {
            await loadLoansWithAnimation();
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–∞
        async function deleteLoan(loanId) {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫—Ä–µ–¥–∏—Ç?')) {
                try {
                    const response = await fetch(`/api/loans/${loanId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        showNotification('üóëÔ∏è –ö—Ä–µ–¥–∏—Ç —É–¥–∞–ª–µ–Ω', 'success');
                        await loadLoansWithAnimation();
                    } else {
                        showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫—Ä–µ–¥–∏—Ç–∞', 'error');
                    }
                } catch (error) {
                    showNotification('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
                }
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞
        function showPaymentModal(loanId) {
            document.getElementById('paymentLoanId').value = loanId;
            document.getElementById('paymentDate').valueAsDate = new Date();
            const modal = document.getElementById('paymentModal');
            modal.style.display = 'block';
            modal.setAttribute('aria-hidden', 'false');
            // –§–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤–æ–µ –ø–æ–ª–µ —Ñ–æ—Ä–º—ã
            document.getElementById('paymentAmount').focus();
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–ª–∞—Ç–µ–∂–µ–π
        async function showPaymentsHistory(loanId) {
            try {
                const response = await fetch(`/api/loans/${loanId}/payments`);
                const payments = await response.json();
                
                const paymentsList = document.getElementById('paymentsList');
                if (payments.length === 0) {
                    paymentsList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üí≥</div>
                            <h3>–ù–µ—Ç –ø–ª–∞—Ç–µ–∂–µ–π</h3>
                            <p>–ü–æ —ç—Ç–æ–º—É –∫—Ä–µ–¥–∏—Ç—É –ø–æ–∫–∞ –Ω–µ—Ç –ø–ª–∞—Ç–µ–∂–µ–π</p>
                            <p class="empty-subtitle">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –ø–ª–∞—Ç–µ–∂, –Ω–∞–∂–∞–≤ –∫–Ω–æ–ø–∫—É üí≥</p>
                        </div>
                    `;
                } else {
                    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–ª–∞—Ç–µ–∂–∏ –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
                    payments.sort((a, b) => new Date(b.payment_date) - new Date(a.payment_date));
                    
                    const totalPaid = payments.reduce((sum, payment) => sum + payment.amount, 0);
                    const averagePayment = totalPaid / payments.length;
                    
                    paymentsList.innerHTML = `
                        <div class="payments-summary">
                            <div class="summary-card">
                                <div class="summary-title">–í—Å–µ–≥–æ –≤—ã–ø–ª–∞—á–µ–Ω–æ</div>
                                <div class="summary-amount">${totalPaid.toLocaleString('ru-RU')} ‚ÇΩ</div>
                            </div>
                            <div class="summary-card">
                                <div class="summary-title">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–ª–∞—Ç–µ–∂–µ–π</div>
                                <div class="summary-amount">${payments.length}</div>
                            </div>
                            <div class="summary-card">
                                <div class="summary-title">–°—Ä–µ–¥–Ω–∏–π –ø–ª–∞—Ç–µ–∂</div>
                                <div class="summary-amount">${averagePayment.toLocaleString('ru-RU')} ‚ÇΩ</div>
                            </div>
                        </div>
                        <div class="payments-timeline">
                            <h3>üìÖ –•—Ä–æ–Ω–æ–ª–æ–≥–∏—è –ø–ª–∞—Ç–µ–∂–µ–π</h3>
                            ${payments.map((payment, index) => `
                                <div class="timeline-item">
                                    <div class="timeline-marker">
                                        <div class="timeline-dot"></div>
                                        ${index === 0 ? '<div class="timeline-line"></div>' : ''}
                                    </div>
                                    <div class="timeline-content">
                                        <div class="payment-date">${new Date(payment.payment_date).toLocaleDateString('ru-RU', {
                                            year: 'numeric',
                                            month: 'long',
                                            day: 'numeric'
                                        })}</div>
                                        <div class="payment-amount">${payment.amount.toLocaleString('ru-RU')} ‚ÇΩ</div>
                                        ${payment.document_name ? 
                                            `<div class="document-info">
                                                <span class="document-icon">üìÑ</span>
                                                <a href="/${payment.document_path}" target="_blank" class="document-link">${payment.document_name}</a>
                                            </div>` : 
                                            '<div class="no-document">–ù–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞</div>'
                                        }
                                        <button onclick="deletePayment(${payment.id})" class="btn btn-danger btn-xs">üóëÔ∏è</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                const modal = document.getElementById('paymentsModal');
                modal.style.display = 'block';
                modal.setAttribute('aria-hidden', 'false');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π');
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫ –ø–ª–∞—Ç–µ–∂–µ–π
        function showLoanChart(loanId) {
            console.log('–û—Ç–∫—Ä—ã–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ –¥–ª—è –∫—Ä–µ–¥–∏—Ç–∞ ID:', loanId);
            const modal = document.getElementById('chartModal');
            modal.style.display = 'block';
            modal.setAttribute('aria-hidden', 'false');
            
            const canvas = document.getElementById('paymentChart');
            const ctx = canvas.getContext('2d');
            
            // –û—á–∏—â–∞–µ–º canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            ctx.fillStyle = '#666';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...', canvas.width / 2, canvas.height / 2);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏ —Ä–∏—Å—É–µ–º –≥—Ä–∞—Ñ–∏–∫
            fetch(`/api/loans/${loanId}/payments`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(payments => {
                    console.log('–ó–∞–≥—Ä—É–∂–µ–Ω—ã –ø–ª–∞—Ç–µ–∂–∏:', payments);
                    if (payments.length === 0) {
                        drawNoDataMessage(ctx, canvas);
                        return;
                    }
                    
                    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–ª–∞—Ç–µ–∂–∏ –ø–æ –¥–∞—Ç–µ
                    payments.sort((a, b) => new Date(a.payment_date) - new Date(b.payment_date));
                    
                    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞
                    const padding = 60;
                    const chartWidth = canvas.width - 2 * padding;
                    const chartHeight = canvas.height - 2 * padding;
                    
                    // –ù–∞—Ö–æ–¥–∏–º –º–∏–Ω–∏–º—É–º –∏ –º–∞–∫—Å–∏–º—É–º —Å –∑–∞–ø–∞—Å–æ–º
                    const amounts = payments.map(p => p.amount);
                    const minAmount = Math.min(...amounts);
                    const maxAmount = Math.max(...amounts);
                    const range = maxAmount - minAmount || 1;
                    const yMin = Math.max(0, minAmount - range * 0.1);
                    const yMax = maxAmount + range * 0.1;
                    const yRange = yMax - yMin;
                    
                    // –†–∏—Å—É–µ–º —Ñ–æ–Ω
                    ctx.fillStyle = '#f8fafc';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // –†–∏—Å—É–µ–º —Å–µ—Ç–∫—É
                    drawGrid(ctx, canvas, padding, chartWidth, chartHeight, yMin, yMax);
                    
                    // –†–∏—Å—É–µ–º –æ—Å–∏
                    drawAxes(ctx, canvas, padding, chartWidth, chartHeight);
                    
                    // –†–∏—Å—É–µ–º –≥—Ä–∞—Ñ–∏–∫
                    drawChart(ctx, payments, padding, chartWidth, chartHeight, yMin, yRange, canvas);
                    
                    // –†–∏—Å—É–µ–º —Ç–æ—á–∫–∏ —Å –ø–æ–¥–ø–∏—Å—è–º–∏
                    drawDataPoints(ctx, payments, padding, chartWidth, chartHeight, yMin, yRange, canvas);
                    
                    // –ü–æ–¥–ø–∏—Å–∏ –æ—Å–µ–π
                    drawAxisLabels(ctx, canvas, padding, chartHeight, yMin, yMax);
                    
                    // –õ–µ–≥–µ–Ω–¥–∞
                    drawLegend(ctx, canvas, payments);
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞:', error);
                    console.error('–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:', error.message);
                    drawErrorMessage(ctx, canvas, error.message);
                });
            
            document.getElementById('chartModal').style.display = 'block';
        }
        
        function drawNoDataMessage(ctx, canvas) {
            ctx.fillStyle = '#666';
            ctx.font = '18px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è', canvas.width / 2, canvas.height / 2);
        }
        
        function drawErrorMessage(ctx, canvas, errorMessage = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö') {
            ctx.fillStyle = '#f00';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', canvas.width / 2, canvas.height / 2 - 20);
            
            if (errorMessage) {
                ctx.font = '12px Arial';
                ctx.fillStyle = '#666';
                ctx.fillText(errorMessage, canvas.width / 2, canvas.height / 2 + 20);
            }
        }
        
        function drawGrid(ctx, canvas, padding, chartWidth, chartHeight, yMin, yMax) {
            ctx.strokeStyle = '#e2e8f0';
            ctx.lineWidth = 1;
            
            // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
            for (let i = 0; i <= 5; i++) {
                const y = padding + (i / 5) * chartHeight;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(padding + chartWidth, y);
                ctx.stroke();
            }
            
            // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
            for (let i = 0; i <= 10; i++) {
                const x = padding + (i / 10) * chartWidth;
                ctx.beginPath();
                ctx.moveTo(x, padding);
                ctx.lineTo(x, padding + chartHeight);
                ctx.stroke();
            }
        }
        
        function drawAxes(ctx, canvas, padding, chartWidth, chartHeight) {
            ctx.strokeStyle = '#2d3748';
            ctx.lineWidth = 2;
            
            // –û—Å—å Y
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, canvas.height - padding);
            ctx.stroke();
            
            // –û—Å—å X
            ctx.beginPath();
            ctx.moveTo(padding, canvas.height - padding);
            ctx.lineTo(canvas.width - padding, canvas.height - padding);
            ctx.stroke();
        }
        
        function drawChart(ctx, payments, padding, chartWidth, chartHeight, yMin, yRange, canvas) {
            ctx.strokeStyle = '#4299e1';
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            payments.forEach((payment, index) => {
                const x = padding + (index / (payments.length - 1)) * chartWidth;
                const y = canvas.height - padding - ((payment.amount - yMin) / yRange) * chartHeight;
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();
        }
        
        function drawDataPoints(ctx, payments, padding, chartWidth, chartHeight, yMin, yRange, canvas) {
            payments.forEach((payment, index) => {
                const x = padding + (index / (payments.length - 1)) * chartWidth;
                const y = canvas.height - padding - ((payment.amount - yMin) / yRange) * chartHeight;
                
                // –¢–æ—á–∫–∞
                ctx.fillStyle = '#4299e1';
                ctx.beginPath();
                ctx.arc(x, y, 6, 0, 2 * Math.PI);
                ctx.fill();
                
                // –ë–µ–ª–∞—è –æ–±–≤–æ–¥–∫–∞
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // –ü–æ–¥–ø–∏—Å—å —Å —Å—É–º–º–æ–π
                ctx.fillStyle = '#2d3748';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(payment.amount.toLocaleString('ru-RU') + ' ‚ÇΩ', x, y - 15);
                
                // –ü–æ–¥–ø–∏—Å—å —Å –¥–∞—Ç–æ–π
                const date = new Date(payment.payment_date);
                const dateStr = date.toLocaleDateString('ru-RU');
                ctx.fillStyle = '#718096';
                ctx.font = '10px Arial';
                ctx.fillText(dateStr, x, y + 25);
            });
        }
        
        function drawAxisLabels(ctx, canvas, padding, chartHeight, yMin, yMax) {
            // –ü–æ–¥–ø–∏—Å—å –æ—Å–∏ X
            ctx.fillStyle = '#2d3748';
            ctx.font = '14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('–ü–ª–∞—Ç–µ–∂–∏ –ø–æ –¥–∞—Ç–µ', canvas.width / 2, canvas.height - 10);
            
            // –ü–æ–¥–ø–∏—Å—å –æ—Å–∏ Y
            ctx.save();
            ctx.translate(20, canvas.height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('–°—É–º–º–∞ (‚ÇΩ)', 0, 0);
            ctx.restore();
            
            // –ü–æ–¥–ø–∏—Å–∏ –∑–Ω–∞—á–µ–Ω–∏–π –Ω–∞ –æ—Å–∏ Y
            ctx.fillStyle = '#718096';
            ctx.font = '11px Arial';
            ctx.textAlign = 'right';
            for (let i = 0; i <= 5; i++) {
                const value = yMin + (i / 5) * (yMax - yMin);
                const y = canvas.height - padding - (i / 5) * chartHeight;
                ctx.fillText(value.toLocaleString('ru-RU'), padding - 10, y + 4);
            }
        }
        
        function drawLegend(ctx, canvas, payments) {
            const totalAmount = payments.reduce((sum, p) => sum + p.amount, 0);
            const avgAmount = totalAmount / payments.length;
            
            ctx.fillStyle = '#2d3748';
            ctx.font = '12px Arial';
            ctx.textAlign = 'left';
            
            const legendY = 30;
            ctx.fillText(`–í—Å–µ–≥–æ –ø–ª–∞—Ç–µ–∂–µ–π: ${payments.length}`, 20, legendY);
            ctx.fillText(`–û–±—â–∞—è —Å—É–º–º–∞: ${totalAmount.toLocaleString('ru-RU')} ‚ÇΩ`, 20, legendY + 20);
            ctx.fillText(`–°—Ä–µ–¥–Ω–∏–π –ø–ª–∞—Ç–µ–∂: ${avgAmount.toLocaleString('ru-RU')} ‚ÇΩ`, 20, legendY + 40);
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
        document.getElementById('paymentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const loanId = formData.get('loan_id');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ñ–∞–π–ª
            const fileInput = document.getElementById('paymentDocument');
            const hasFile = fileInput.files.length > 0;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ñ–∞–π–ª–∞
            if (!hasFile) {
                showNotification('‚ùå –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç (—á–µ–∫) –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞', 'error');
                return;
            }
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å —Ñ–∞–π–ª–æ–º
            const response = await fetch('/api/payments', {
                method: 'POST',
                body: formData
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞...';
            submitBtn.disabled = true;
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    // –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–µ JSON, –≤–µ—Ä–æ—è—Ç–Ω–æ —ç—Ç–æ HTML (—Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—Ö–æ–¥–∞)
                    showNotification('‚ö†Ô∏è –°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –∑–∞–Ω–æ–≤–æ.', 'error');
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 2000);
                    return;
                }
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–µ—Ä–µ—Ä–∞—Å—á–µ—Ç–µ
                    let notificationMessage = '‚úÖ –ü–ª–∞—Ç–µ–∂ —Å –¥–æ–∫—É–º–µ–Ω—Ç–æ–º —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!';
                    if (result.recalculation && result.recalculation.recalculated) {
                        if (result.recalculation.remaining_amount <= 0) {
                            notificationMessage = 'üéâ –ö—Ä–µ–¥–∏—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–≥–∞—à–µ–Ω!';
                        } else if (result.recalculation.payment_breakdown) {
                            const breakdown = result.recalculation.payment_breakdown;
                            notificationMessage = `‚úÖ –ü–ª–∞—Ç–µ–∂ —Å –¥–æ–∫—É–º–µ–Ω—Ç–æ–º –¥–æ–±–∞–≤–ª–µ–Ω! –ù–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂: ${result.recalculation.new_monthly_payment.toLocaleString('ru-RU')} ‚ÇΩ (–û—Å–Ω–æ–≤–Ω–æ–π –¥–æ–ª–≥: ${breakdown.principal.toLocaleString('ru-RU')} ‚ÇΩ, –ü—Ä–æ—Ü–µ–Ω—Ç—ã: ${breakdown.interest.toLocaleString('ru-RU')} ‚ÇΩ)`;
                        } else {
                            notificationMessage = `‚úÖ –ü–ª–∞—Ç–µ–∂ —Å –¥–æ–∫—É–º–µ–Ω—Ç–æ–º –¥–æ–±–∞–≤–ª–µ–Ω! –ù–æ–≤—ã–π –µ–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç–µ–∂: ${result.recalculation.new_monthly_payment.toLocaleString('ru-RU')} ‚ÇΩ`;
                        }
                    }
                    showNotification(notificationMessage, 'success');
                    
                    // –ê–Ω–∏–º–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                    await animateLoanUpdate(loanId);
                    
                    this.reset();
                    document.getElementById('paymentDate').valueAsDate = new Date();
                    const modal = document.getElementById('paymentModal');
                    modal.style.display = 'none';
                    modal.setAttribute('aria-hidden', 'true');
                    
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
                    await loadLoansWithAnimation();
                } else {
                    let errorMessage = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                    } catch (jsonError) {
                        // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–µ—Ç—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–¥
                        errorMessage = `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status} ${response.statusText}`;
                    }
                    
                    // –î–µ—Ç–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏
                    if (errorMessage.includes('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç')) {
                        errorMessage = '‚ö†Ô∏è –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç (—á–µ–∫) –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞';
                    } else if (errorMessage.includes('–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞')) {
                        errorMessage = '‚ö†Ô∏è –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞. –†–∞–∑—Ä–µ—à–µ–Ω—ã: PDF, PNG, JPG, JPEG, GIF, DOC, DOCX';
                    } else if (errorMessage.includes('–ö—Ä–µ–¥–∏—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω')) {
                        errorMessage = '‚ö†Ô∏è –ö—Ä–µ–¥–∏—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞';
                    }
                    
                    showNotification(`‚ùå ${errorMessage}`, 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞:', error);
                
                let errorMessage = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏';
                if (error.message.includes('Failed to fetch')) {
                    errorMessage = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É';
                } else if (error.message.includes('TypeError')) {
                    errorMessage = '–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö';
                } else {
                    errorMessage = `–û—à–∏–±–∫–∞: ${error.message}`;
                }
                
                showNotification(`‚ùå ${errorMessage}`, 'error');
            } finally {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // –£–¥–∞–ª–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
        async function deletePayment(paymentId) {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–ª–∞—Ç–µ–∂?')) {
                try {
                    const response = await fetch(`/api/payments/${paymentId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        showNotification('üóëÔ∏è –ü–ª–∞—Ç–µ–∂ —É–¥–∞–ª–µ–Ω', 'success');
                        await loadLoansWithAnimation();
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–ª–∞—Ç–µ–∂–µ–π –µ—Å–ª–∏ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ
                        const paymentsModal = document.getElementById('paymentsModal');
                        if (paymentsModal.style.display === 'block') {
                            const loanId = document.getElementById('paymentLoanId').value;
                            showPaymentsHistory(loanId);
                        }
                    } else {
                        showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞', 'error');
                    }
                } catch (error) {
                    showNotification('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
                }
            }
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
        document.querySelectorAll('.close').forEach(closeBtn => {
            closeBtn.addEventListener('click', function() {
                const modal = this.closest('.modal');
                modal.style.display = 'none';
                modal.setAttribute('aria-hidden', 'true');
            });
        });
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –∏—Ö
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
                event.target.setAttribute('aria-hidden', 'true');
            }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        });

        // –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function showNotification(message, type = 'info') {
            // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notif => notif.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <span class="notification-message">${message}</span>
                    <button class="notification-close">&times;</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                hideNotification(notification);
            }, 3000);
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É
            notification.querySelector('.notification-close').addEventListener('click', () => {
                hideNotification(notification);
            });
        }
        
        function hideNotification(notification) {
            notification.classList.add('hide');
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }
        
        // –ê–Ω–∏–º–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫—Ä–µ–¥–∏—Ç–∞
        async function animateLoanUpdate(loanId) {
            const loanRow = document.querySelector(`tr[data-loan-id="${loanId}"]`);
            if (loanRow) {
                loanRow.classList.add('updating');
                
                // –ê–Ω–∏–º–∞—Ü–∏—è –ø—É–ª—å—Å–∞—Ü–∏–∏
                const progressBar = loanRow.querySelector('.progress-fill');
                if (progressBar) {
                    progressBar.classList.add('pulse');
                }
                
                // –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                loanRow.classList.remove('updating');
                if (progressBar) {
                    progressBar.classList.remove('pulse');
                }
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
        async function loadLoansWithAnimation() {
            const tbody = document.getElementById('loansTableBody');
            
            // –î–æ–±–∞–≤–ª—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç –∑–∞–≥—Ä—É–∑–∫–∏
            tbody.style.opacity = '0.5';
            tbody.style.transform = 'scale(0.98)';
            
            try {
                const response = await fetch('/api/loans');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    // –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–µ JSON, –≤–µ—Ä–æ—è—Ç–Ω–æ —ç—Ç–æ HTML (—Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—Ö–æ–¥–∞)
                    showNotification('‚ö†Ô∏è –°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –∑–∞–Ω–æ–≤–æ.', 'error');
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 2000);
                    return;
                }
                
                const loans = await response.json();
                console.log('–ó–∞–≥—Ä—É–∂–µ–Ω—ã –∫—Ä–µ–¥–∏—Ç—ã:', loans);
                
                // –û—á–∏—â–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
                tbody.innerHTML = '';
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫—Ä–µ–¥–∏—Ç—ã
                if (loans.length === 0) {
                    const userRole = document.getElementById('userRole').textContent;
                    const emptyContent = userRole === '–ö—Ä–µ–¥–∏—Ç–æ–¥–∞—Ç–µ–ª—å' ? 
                        `<div class="empty-state">
                            <div class="empty-icon">üí≥</div>
                            <h3>–ù–µ—Ç –∫—Ä–µ–¥–∏—Ç–æ–≤</h3>
                            <p>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –∫—Ä–µ–¥–∏—Ç, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É</p>
                            <button onclick="showTab('calculate')" class="btn btn-primary">üí≥ –°–æ–∑–¥–∞—Ç—å –∫—Ä–µ–¥–∏—Ç</button>
                        </div>` :
                        `<div class="empty-state">
                            <div class="empty-icon">üìã</div>
                            <h3>–ù–µ—Ç –∫—Ä–µ–¥–∏—Ç–æ–≤</h3>
                            <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫—Ä–µ–¥–∏—Ç–æ–≤</p>
                            <p class="empty-subtitle">–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∫—Ä–µ–¥–∏—Ç–æ–¥–∞—Ç–µ–ª—é –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫—Ä–µ–¥–∏—Ç–∞</p>
                        </div>`;
                    
                    // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä–æ–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ
                    const row = document.createElement('tr');
                    const cell = document.createElement('td');
                    cell.colSpan = 6;
                    cell.className = 'empty-state';
                    cell.innerHTML = emptyContent;
                    row.appendChild(cell);
                    tbody.appendChild(row);
                } else {
                    // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
                    for (let i = 0; i < loans.length; i++) {
                    const loan = loans[i];
                    const row = document.createElement('tr');
                    row.setAttribute('data-loan-id', loan.id);
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫—Ä–µ–¥–∏—Ç–∞
                    const isCompleted = loan.progress_percent >= 100;
                    
                    // –†–∞—Å—á–µ—Ç –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –º–µ—Å—è—Ü–µ–≤ (–±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–π —Ä–∞—Å—á–µ—Ç)
                    const startDate = new Date(loan.start_date);
                    const currentDate = new Date();
                    const monthsPassed = (currentDate.getFullYear() - startDate.getFullYear()) * 12 + 
                                       (currentDate.getMonth() - startDate.getMonth());
                    const remainingMonths = Math.max(0, loan.term_months - monthsPassed);
                    
                    // –ö—Ä–µ–¥–∏—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω, –µ—Å–ª–∏ —Å—Ä–æ–∫ –∏—Å—Ç–µ–∫, –Ω–æ –Ω–µ –ø–æ–≥–∞—à–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é
                    const isOverdue = !isCompleted && remainingMonths <= 0;
                    const statusClass = isCompleted ? 'completed' : isOverdue ? 'overdue' : 'active';
                    const statusIcon = isCompleted ? '‚úÖ' : isOverdue ? '‚ö†Ô∏è' : 'üîÑ';
                    
                    // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ)
                    console.log(`–ö—Ä–µ–¥–∏—Ç ${loan.id}:`, {
                        startDate: loan.start_date,
                        termMonths: loan.term_months,
                        monthsPassed,
                        remainingMonths,
                        isCompleted,
                        isOverdue,
                        progressPercent: loan.progress_percent
                    });
                    
                    // –£–ª—É—á—à–µ–Ω–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
                    const progressBar = `
                        <div class="progress-container">
                            <div class="progress-header">
                                <span class="progress-percent">${loan.progress_percent.toFixed(1)}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill ${statusClass}" style="width: ${Math.min(loan.progress_percent, 100)}%"></div>
                            </div>
                            <div class="progress-details">
                                <div class="progress-amounts">
                                    <span class="paid">–í—ã–ø–ª–∞—á–µ–Ω–æ: ${loan.total_paid.toLocaleString('ru-RU')} ‚ÇΩ</span>
                                    <span class="remaining">–û—Å—Ç–∞–ª–æ—Å—å: ${loan.remaining_amount.toLocaleString('ru-RU')} ‚ÇΩ</span>
                                </div>
                                <div class="progress-stats">
                                    <span class="payments-count">–ü–ª–∞—Ç–µ–∂–µ–π: ${loan.payments_count}</span>
                                    <span class="months-left">–ú–µ—Å—è—Ü–µ–≤: ${remainingMonths}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    row.className = `loan-row ${statusClass}`;
                    row.innerHTML = `
                        <td>
                            <div class="loan-amount">
                                <div class="amount-main">${loan.amount.toLocaleString('ru-RU')} ‚ÇΩ</div>
                                <div class="amount-details">–ü–æ–¥ ${loan.interest_rate}% –≥–æ–¥–æ–≤—ã—Ö</div>
                                <div class="user-info">
                                    <span class="user-icon">üë§</span>
                                    <span class="user-name">${loan.user_name}</span>
                                    <span class="user-role">(${loan.user_role_display})</span>
                                </div>
                                <div class="loan-status">
                                    <span class="status-icon">${statusIcon}</span>
                                    <span class="status-text ${statusClass}">${isCompleted ? '–ü–æ–≥–∞—à–µ–Ω' : isOverdue ? '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω' : '–ê–∫—Ç–∏–≤–µ–Ω'}</span>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="loan-dates">
                                <div class="start-date">üìÖ ${new Date(loan.start_date).toLocaleDateString('ru-RU')}</div>
                                <div class="term-info">‚è±Ô∏è ${loan.term_months} –º–µ—Å</div>
                                <div class="remaining-time">${remainingMonths > 0 ? `–û—Å—Ç–∞–ª–æ—Å—å: ${remainingMonths} –º–µ—Å` : isOverdue ? '‚ö†Ô∏è –°—Ä–æ–∫ –∏—Å—Ç–µ–∫' : '–°—Ä–æ–∫ –∏—Å—Ç–µ–∫'}</div>
                                <div class="planned-last-payment-info">üìÖ –ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–ª–∞—Ç–µ–∂ –ø–æ –ø–ª–∞–Ω—É: ${loan.planned_last_payment_date ? new Date(loan.planned_last_payment_date).toLocaleDateString('ru-RU') : '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ'}</div>
                            </div>
                        </td>
                        <td>
                            <div class="payment-info">
                                <div class="monthly-payment">üí≥ ${loan.monthly_payment.toLocaleString('ru-RU')} ‚ÇΩ/–º–µ—Å</div>
                                <div class="total-payment">üí∞ –í—Å–µ–≥–æ: ${loan.total_payment.toLocaleString('ru-RU')} ‚ÇΩ</div>
                            </div>
                        </td>
                        <td>
                            <div class="recalculated-payment-info">
                                ${loan.payments_count > 0 ? `
                                    <div class="recalculated-payment">
                                        <div class="recalculated-amount">${loan.remaining_amount > 0 ? 
                                            (loan.remaining_amount / Math.max(remainingMonths, 1)).toLocaleString('ru-RU') + ' ‚ÇΩ/–º–µ—Å' : 
                                            '–ö—Ä–µ–¥–∏—Ç –ø–æ–≥–∞—à–µ–Ω'
                                        }</div>
                                        <div class="recalculated-breakdown">
                                            ${loan.remaining_amount > 0 && remainingMonths > 0 ? `
                                                <div class="breakdown-item">
                                                    <span class="breakdown-label">üìä –û—Å–Ω–æ–≤–Ω–æ–π –¥–æ–ª–≥:</span>
                                                    <span class="breakdown-amount">${((loan.remaining_amount / Math.max(remainingMonths, 1)) * 0.8).toLocaleString('ru-RU')} ‚ÇΩ</span>
                                                </div>
                                                <div class="breakdown-item">
                                                    <span class="breakdown-label">üí∏ –ü—Ä–æ—Ü–µ–Ω—Ç—ã:</span>
                                                    <span class="breakdown-amount">${((loan.remaining_amount / Math.max(remainingMonths, 1)) * 0.2).toLocaleString('ru-RU')} ‚ÇΩ</span>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                ` : `
                                    <div class="no-recalculation">
                                        <span class="no-recalc-text">–ù–µ—Ç –ø–ª–∞—Ç–µ–∂–µ–π</span>
                                        <span class="no-recalc-subtext">–ü–µ—Ä–µ—Å—á–µ—Ç –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞</span>
                                    </div>
                                `}
                            </div>
                        </td>
                        <td>${progressBar}</td>
                        <td>
                            <div class="action-buttons" role="group" aria-label="–î–µ–π—Å—Ç–≤–∏—è —Å –∫—Ä–µ–¥–∏—Ç–æ–º">
                                <button onclick="showPaymentModal(${loan.id})" class="btn btn-primary btn-sm" 
                                        title="–î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç–µ–∂" aria-label="–î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç–µ–∂ –¥–ª—è –∫—Ä–µ–¥–∏—Ç–∞ ${loan.id}">üí≥</button>
                                <button onclick="showPaymentsHistory(${loan.id})" class="btn btn-secondary btn-sm" 
                                        title="–ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–ª–∞—Ç–µ–∂–µ–π –¥–ª—è –∫—Ä–µ–¥–∏—Ç–∞ ${loan.id}">üìä</button>
                                <button onclick="showLoanChart(${loan.id})" class="btn btn-info btn-sm" 
                                        title="–ì—Ä–∞—Ñ–∏–∫ –ø–ª–∞—Ç–µ–∂–µ–π" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫ –ø–ª–∞—Ç–µ–∂–µ–π –¥–ª—è –∫—Ä–µ–¥–∏—Ç–∞ ${loan.id}">üìà</button>
                                ${'{{ user_role }}' === '–ö—Ä–µ–¥–∏—Ç–æ–¥–∞—Ç–µ–ª—å' ? 
                                    `<button onclick="deleteLoan(${loan.id})" class="btn btn-danger btn-sm" 
                                            title="–£–¥–∞–ª–∏—Ç—å –∫—Ä–µ–¥–∏—Ç" aria-label="–£–¥–∞–ª–∏—Ç—å –∫—Ä–µ–¥–∏—Ç ${loan.id}">üóëÔ∏è</button>` : 
                                    ''
                                }
                            </div>
                        </td>
                    `;
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ –∫–∞—Å–∫–∞–¥–∞
                    setTimeout(() => {
                        tbody.appendChild(row);
                        row.classList.add('slide-in');
                    }, i * 100);
                }
                
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
                    setTimeout(() => {
                        tbody.style.opacity = '1';
                        tbody.style.transform = 'scale(1)';
                    }, loans.length * 100 + 200);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—Ä–µ–¥–∏—Ç–æ–≤:', error);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –æ—à–∏–±–∫—É
                let errorMessage = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—Ä–µ–¥–∏—Ç–æ–≤';
                if (error.message.includes('HTTP')) {
                    errorMessage = `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${error.message}`;
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É';
                } else {
                    errorMessage = `–û—à–∏–±–∫–∞: ${error.message}`;
                }
                
                showNotification(`‚ùå ${errorMessage}`, 'error');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å –æ—à–∏–±–∫–æ–π
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="error-state">
                            <div class="empty-state">
                                <div class="empty-icon">‚ö†Ô∏è</div>
                                <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫—Ä–µ–¥–∏—Ç—ã</p>
                                <p class="empty-subtitle">${errorMessage}</p>
                                <button onclick="loadLoansWithAnimation()" class="btn btn-primary">üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
                            </div>
                        </td>
                    </tr>
                `;
                
                tbody.style.opacity = '1';
                tbody.style.transform = 'scale(1)';
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –≤—ã—Ö–æ–¥–∞
        function logout() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã?')) {
                window.location.href = '/logout';
            }
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function displayUserRole() {
            const userRoleElement = document.getElementById('userRole');
            const userRole = '{{ user_role }}';
            
            if (userRoleElement) {
                userRoleElement.textContent = userRole;
            }
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
            setupInterfaceForRole(userRole);
        }
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
        function setupInterfaceForRole(role) {
            const loanFormSection = document.getElementById('loanFormSection');
            const managementTab = document.getElementById('managementTab');
            const calculateTab = document.getElementById('calculateTab');
            const createBorrowerSection = document.getElementById('createBorrowerSection');
            const borrowersListSection = document.getElementById('borrowersListSection');
            
            if (role === '–ó–∞–∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–Ω—ã–π') {
                // –°–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Å–æ–∑–¥–∞–Ω–∏—è –∫—Ä–µ–¥–∏—Ç–∞, –≤–∫–ª–∞–¥–∫—É —Ä–∞—Å—Å—á–µ—Ç–∞ –∏ –≤–∫–ª–∞–¥–∫—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –∑–∞–∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–Ω—ã—Ö
                if (loanFormSection) {
                    loanFormSection.style.display = 'none';
                }
                if (managementTab) {
                    managementTab.style.display = 'none';
                }
                if (calculateTab) {
                    calculateTab.style.display = 'none';
                }
                if (createBorrowerSection) {
                    createBorrowerSection.style.display = 'none';
                }
                if (borrowersListSection) {
                    borrowersListSection.style.display = 'none';
                }
                
                // –ò–∑–º–µ–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å–µ–∫—Ü–∏–∏ –∫—Ä–µ–¥–∏—Ç–æ–≤
                const loansSection = document.querySelector('.loans-section h2');
                if (loansSection) {
                    loansSection.textContent = 'üìã –ú–æ–∏ –∫—Ä–µ–¥–∏—Ç—ã';
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∫–ª–∞–¥–∫—É "–ò—Å—Ç–æ—Ä–∏—è –∫—Ä–µ–¥–∏—Ç–æ–≤" –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –∑–∞–∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–Ω—ã—Ö
                showTab('history');
            } else {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Å–æ–∑–¥–∞–Ω–∏—è –∫—Ä–µ–¥–∏—Ç–∞ –∏ –≤–∫–ª–∞–¥–∫—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –∫—Ä–µ–¥–∏—Ç–æ–¥–∞—Ç–µ–ª–µ–π
                if (loanFormSection) {
                    loanFormSection.style.display = 'block';
                }
                if (managementTab) {
                    managementTab.style.display = 'inline-block';
                }
                if (calculateTab) {
                    calculateTab.style.display = 'inline-block';
                }
                if (createBorrowerSection) {
                    createBorrowerSection.style.display = 'block';
                }
                if (borrowersListSection) {
                    borrowersListSection.style.display = 'block';
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∫–ª–∞–¥–∫—É "–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∫—Ä–µ–¥–∏—Ç" –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –∫—Ä–µ–¥–∏—Ç–æ–¥–∞—Ç–µ–ª–µ–π
                showTab('calculate');
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∑–∞–∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–Ω—ã—Ö
        async function loadBorrowers() {
            try {
                const response = await fetch('/api/borrowers');
                if (response.ok) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        // –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–µ JSON, –≤–µ—Ä–æ—è—Ç–Ω–æ —ç—Ç–æ HTML (—Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—Ö–æ–¥–∞)
                        showNotification('‚ö†Ô∏è –°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –∑–∞–Ω–æ–≤–æ.', 'error');
                        setTimeout(() => {
                            window.location.href = '/login';
                        }, 2000);
                        return;
                    }
                    
                    const borrowers = await response.json();
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–∞—Ä–æ–ª–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    for (let borrower of borrowers) {
                        try {
                            const credResponse = await fetch(`/api/borrowers/${borrower.id}/credentials`);
                            if (credResponse.ok) {
                                const credentials = await credResponse.json();
                                borrower.password = credentials.password;
                            }
                        } catch (error) {
                            console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞—Ä–æ–ª—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${borrower.id}:`, error);
                            borrower.password = 'password123'; // Fallback
                        }
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º select –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫—Ä–µ–¥–∏—Ç–∞
                    const select = document.getElementById('borrower_id');
                    if (select) {
                        // –û—á–∏—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–ø—Ü–∏–∏
                        select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–Ω–æ–≥–æ...</option>';
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–Ω—ã—Ö
                        borrowers.forEach(borrower => {
                            const option = document.createElement('option');
                            option.value = borrower.id;
                            option.textContent = borrower.full_name;
                            select.appendChild(option);
                        });
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–Ω—ã—Ö –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
                    displayBorrowersList(borrowers);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–Ω—ã—Ö:', error);
            }
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∑–∞–∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–Ω—ã—Ö
        function displayBorrowersList(borrowers) {
            const borrowersList = document.getElementById('borrowersList');
            if (!borrowersList) return;
            
            if (borrowers.length === 0) {
                borrowersList.innerHTML = '<p style="text-align: center; color: #718096;">–ù–µ—Ç –∑–∞–∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>';
                return;
            }
            
            borrowersList.innerHTML = borrowers.map(borrower => `
                <div class="borrower-card">
                    <div class="borrower-name">${borrower.full_name}</div>
                    <div class="borrower-credentials">
                        <div class="credential-item">
                            <span class="credential-label">üë§ –õ–æ–≥–∏–Ω:</span>
                            <span class="credential-value" id="username-${borrower.id}">${borrower.username}</span>
                            <button onclick="copyToClipboard('username-${borrower.id}')" class="copy-credential-btn" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏–Ω">üìã</button>
                        </div>
                        <div class="credential-item">
                            <span class="credential-label">üîë –ü–∞—Ä–æ–ª—å:</span>
                            <span class="credential-value" id="password-${borrower.id}">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
                            <button onclick="togglePassword(${borrower.id}, '${borrower.password}')" class="toggle-password-btn" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å">üëÅÔ∏è</button>
                            <button onclick="copyToClipboard('password-${borrower.id}')" class="copy-credential-btn" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–æ–ª—å">üìã</button>
                        </div>
                        <div class="borrower-id">ID: ${borrower.id}</div>
                    </div>
                    <div class="borrower-actions">
                        <button onclick="deleteBorrower(${borrower.id}, '${borrower.full_name}')" 
                                class="btn btn-danger btn-sm" 
                                title="–£–¥–∞–ª–∏—Ç—å –∑–∞–∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–Ω–æ–≥–æ">
                            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∑–∞–∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–Ω–æ–≥–æ
        document.getElementById('createBorrowerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = {
                full_name: formData.get('full_name'),
                username: formData.get('username'),
                password: formData.get('password')
            };
            
            try {
                const response = await fetch('/api/borrowers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞
                    showCredentials(result.credentials);
                    
                    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                    this.reset();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–Ω—ã—Ö
                    loadBorrowers();
                    
                    showNotification(`‚úÖ ${result.message}`, 'success');
                } else {
                    showNotification(`‚ùå ${result.error}`, 'error');
                }
            } catch (error) {
                showNotification(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error');
            }
        });
        
        // –ü–æ–∫–∞–∑ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—Ö–æ–¥–∞
        function showCredentials(credentials) {
            const form = document.getElementById('createBorrowerForm');
            let credentialsDisplay = form.querySelector('.credentials-display');
            
            if (!credentialsDisplay) {
                credentialsDisplay = document.createElement('div');
                credentialsDisplay.className = 'credentials-display';
                form.appendChild(credentialsDisplay);
            }
            
            credentialsDisplay.innerHTML = `
                <h4>üìã –î–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞ —Å–æ–∑–¥–∞–Ω—ã!</h4>
                <div class="full-name">üë§ –§–ò–û: ${credentials.full_name}</div>
                <div class="username">üë§ –õ–æ–≥–∏–Ω: ${credentials.username}</div>
                <div class="password">üîë –ü–∞—Ä–æ–ª—å: ${credentials.password}</div>
                <button class="copy-btn" onclick="copyCredentials('${credentials.full_name}', '${credentials.username}', '${credentials.password}')">
                    üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
                </button>
            `;
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                if (credentialsDisplay.parentNode) {
                    credentialsDisplay.remove();
                }
            }, 30000);
        }
        
        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—Ö–æ–¥–∞
        function copyCredentials(fullName, username, password) {
            const text = `–§–ò–û: ${fullName}\n–õ–æ–≥–∏–Ω: ${username}\n–ü–∞—Ä–æ–ª—å: ${password}`;
            navigator.clipboard.writeText(text).then(() => {
                showNotification('üìã –î–∞–Ω–Ω—ã–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
            }).catch(() => {
                showNotification('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ', 'error');
            });
        }
        
        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            navigator.clipboard.writeText(text).then(() => {
                showNotification('üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
            }).catch(() => {
                showNotification('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å', 'error');
            });
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–∞—Ä–æ–ª—è
        function togglePassword(borrowerId, realPassword) {
            const passwordElement = document.getElementById(`password-${borrowerId}`);
            const button = event.target;
            
            if (passwordElement.textContent === '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
                passwordElement.textContent = realPassword;
                button.textContent = 'üôà';
                button.title = '–°–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å';
            } else {
                passwordElement.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                button.textContent = 'üëÅÔ∏è';
                button.title = '–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å';
            }
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function deleteBorrower(borrowerId, borrowerName) {
            const confirmed = confirm(
                `‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï!\n\n` +
                `–í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞–∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${borrowerName}".\n\n` +
                `–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —É–¥–∞–ª–∏—Ç:\n` +
                `‚Ä¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${borrowerName}"\n` +
                `‚Ä¢ –í—Å–µ –µ–≥–æ –∫—Ä–µ–¥–∏—Ç—ã\n` +
                `‚Ä¢ –í—Å–µ –ø–ª–∞—Ç–µ–∂–∏ –ø–æ —ç—Ç–∏–º –∫—Ä–µ–¥–∏—Ç–∞–º\n` +
                `‚Ä¢ –í—Å–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã\n\n` +
                `–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –ù–ï–û–ë–†–ê–¢–ò–ú–û!\n\n` +
                `–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`
            );
            
            if (!confirmed) {
                return;
            }
            
            try {
                const response = await fetch(`/api/borrowers/${borrowerId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showNotification(`‚úÖ ${result.message}`, 'success');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–Ω—ã—Ö
                    loadBorrowers();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫—Ä–µ–¥–∏—Ç–æ–≤
                    loadLoansWithAnimation();
                } else {
                    showNotification(`‚ùå ${result.error}`, 'error');
                }
            } catch (error) {
                showNotification(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error');
            }
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É –∫–Ω–æ–ø–∫–∏
            const themeBtn = document.querySelector('.theme-toggle-btn');
            themeBtn.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            themeBtn.title = newTheme === 'dark' ? '–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ —Å–≤–µ—Ç–ª—É—é —Ç–µ–º—É' : '–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ —Ç–µ–º–Ω—É—é —Ç–µ–º—É';
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π —Ç–µ–º—ã
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            
            const themeBtn = document.querySelector('.theme-toggle-btn');
            themeBtn.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            themeBtn.title = savedTheme === 'dark' ? '–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ —Å–≤–µ—Ç–ª—É—é —Ç–µ–º—É' : '–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ —Ç–µ–º–Ω—É—é —Ç–µ–º—É';
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Main page script loaded');
            loadTheme();
            displayUserRole();
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('start_date').value = today;
        });
    </script>
</body>
</html>
